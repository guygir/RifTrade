# Vercel Environment Variables Checklist

## Required Environment Variables for Production

You need to add these environment variables in your Vercel project settings:

### 1. Supabase Configuration (Already Set)
These should already be configured from your initial deployment:

- ✅ `NEXT_PUBLIC_SUPABASE_URL` = `https://xwjkuxwyfkxbfqwrwpbv.supabase.co`
- ✅ `NEXT_PUBLIC_SUPABASE_ANON_KEY` = `sb_publishable_CitxTYS4iWSsDcU_fbTdTQ_HjuCnQTr`

### 2. Service Role Key (CRITICAL - Must Add)
This is required for the meta data refresh to work:

- ⚠️ `SUPABASE_SERVICE_ROLE_KEY` = `<your-service-role-key-from-supabase-dashboard>`

**To get this key:**
1. Go to your Supabase project dashboard
2. Navigate to Settings → API
3. Copy the `service_role` key (keep this secret!)

### 3. Meta Data Configuration (Must Add)
These control the Popular Decks & Cards feature:

- ⚠️ `META_UPDATE_ENABLED` = `true`
- ⚠️ `META_CACHE_DURATION_HOURS` = `24`

### 4. Cron Secret (Auto-Generated by Vercel)
**DO NOT ADD THIS MANUALLY** - Vercel automatically provides this when you have a cron job configured:

- ✅ `CRON_SECRET` - Automatically set by Vercel (no action needed)

---

## How to Add Environment Variables in Vercel

1. Go to your Vercel dashboard: https://vercel.com/dashboard
2. Select your project (Rift)
3. Go to **Settings** → **Environment Variables**
4. Add each variable:
   - **Key**: Variable name (e.g., `SUPABASE_SERVICE_ROLE_KEY`)
   - **Value**: The value from above
   - **Environments**: Select **Production**, **Preview**, and **Development**
5. Click **Save**
6. **Redeploy** your project for changes to take effect

---

## Verification Steps

After adding the environment variables and redeploying:

### 1. Check if cron job is registered
```bash
# In Vercel dashboard, go to:
# Project → Settings → Cron Jobs
# You should see: /api/meta/refresh scheduled for "0 0 * * *"
```

### 2. Test the refresh endpoint manually
```bash
# Get your production URL (e.g., https://rift.vercel.app)
curl -X POST https://YOUR-DOMAIN.vercel.app/api/meta/refresh \
  -H "Authorization: Bearer YOUR_CRON_SECRET" \
  -H "Content-Type: application/json"
```

**Note:** You can find your `CRON_SECRET` in Vercel's environment variables after the first deployment with vercel.json.

### 3. Check the status endpoint
```bash
curl -X GET https://YOUR-DOMAIN.vercel.app/api/meta/refresh \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### 4. Verify data is showing on the site
- Visit your production site
- Check the home page for "Popular Decks by Tier"
- Check the /cards page for "Popular Cards"
- Click "Expand" to see if data loads

---

## Troubleshooting

### If cron job doesn't appear in Vercel dashboard:
1. Make sure `vercel.json` is committed to your repository
2. Redeploy the project
3. Check Vercel logs for any errors

### If refresh endpoint returns 401 Unauthorized:
- The `CRON_SECRET` environment variable is missing or incorrect
- Vercel should auto-generate this when you have a cron job configured

### If refresh endpoint returns 500 Error:
- Check Vercel function logs for detailed error messages
- Verify `SUPABASE_SERVICE_ROLE_KEY` is set correctly
- Ensure database migrations have been run on production

### If no data shows on the site:
1. Manually trigger a refresh using the curl command above
2. Check Vercel function logs for errors
3. Verify the database has the `meta_snapshots`, `popular_decks`, and `popular_cards` tables

---

## Database Migration for Production

If you haven't run the migrations on your production Supabase instance:

1. Go to Supabase dashboard: https://supabase.com/dashboard
2. Select your project
3. Go to **SQL Editor**
4. Run these migrations in order:
   - `supabase/migrations/006_add_meta_tables.sql`
   - `supabase/migrations/007_add_weighted_metrics.sql`

---

## Summary

**Must Add to Vercel:**
1. ⚠️ `SUPABASE_SERVICE_ROLE_KEY`
2. ⚠️ `META_UPDATE_ENABLED`
3. ⚠️ `META_CACHE_DURATION_HOURS`

**Auto-Generated by Vercel:**
- ✅ `CRON_SECRET` (no action needed)

**Already Set:**
- ✅ `NEXT_PUBLIC_SUPABASE_URL`
- ✅ `NEXT_PUBLIC_SUPABASE_ANON_KEY`

After adding these and redeploying, the cron job will automatically run daily at midnight UTC to refresh the meta data!